# Руководство по деплою TalkeryBot на Render.com

Это руководство поможет вам развернуть TalkeryBot на платформе Render.com.

## Предварительные требования

1. Аккаунт на [Render.com](https://render.com/)
2. Бот, зарегистрированный через [@BotFather](https://t.me/BotFather) в Telegram
3. Исходный код проекта

## Шаги по деплою

### 1. Подготовка кода

Для размещения бота на Render.com вам необходимо использовать версию бота с вебхуком (`bot_webhook.py`) вместо поллинга (`bot.py`).

### 2. Создание базы данных PostgreSQL

1. Войдите в свой аккаунт на Render.com
2. Перейдите в раздел "New" и выберите "PostgreSQL"
3. Заполните следующие поля:
   - Name: talkerybot-db (или любое другое название)
   - Database: talkerybot
   - User: talkerybot_user
   - Region: выберите ближайший к вам регион
4. Нажмите "Create Database"
5. После создания БД, запишите `Internal Database URL` - он понадобится далее

### 3. Создание веб-сервиса

1. На Render.com перейдите в раздел "New" и выберите "Web Service"
2. Подключите свой репозиторий GitHub или используйте публичный репозиторий
3. Заполните следующие поля:
   - Name: talkerybot
   - Region: выберите тот же регион, что и для БД
   - Branch: main (или другую ветку по необходимости)
   - Runtime: Python 3
   - Build Command: `pip install -r requirements.txt && python init_db.py`
   - Start Command: `python bot_webhook.py`
4. В разделе "Environment" добавьте следующие переменные окружения:
   - `BOT_TOKEN`: токен вашего Telegram бота (получен от BotFather)
   - `DATABASE_URL`: значение из поля `Internal Database URL`, скопированное на шаге 2
   - `WEBHOOK_HOST`: URL вашего веб-сервиса на Render.com (example: https://talkerybot.onrender.com)
   - `PORT`: 8000

5. Нажмите "Create Web Service"

### 4. Настройка вебхука

После успешного деплоя, ваш бот автоматически настроит вебхук во время запуска. Однако, если вы хотите настроить его вручную, выполните следующие действия:

1. Запустите `webhook_setup.py` локально, установив переменные окружения:
   ```
   BOT_TOKEN=ваш_токен
   WEBHOOK_HOST=https://ваш-проект.onrender.com
   ```

2. Либо запросите обновление вебхука через Telegram API:
   ```
   https://api.telegram.org/bot<BOT_TOKEN>/setWebhook?url=https://ваш-проект.onrender.com/webhook/<BOT_TOKEN>
   ```

### 5. Дополнительные настройки для Render.com

1. **Бесплатный план**: по умолчанию, бесплатные веб-сервисы Render.com засыпают после 15 минут неактивности. Учтите это при использовании.

2. **Масштабирование**: если ваш бот становится популярным, рассмотрите возможность перехода на платный план.

3. **Логи**: на Render.com вы можете просматривать логи вашего бота, что полезно для отладки.

## Обновление бота

1. Внесите изменения в код и отправьте их в репозиторий
2. Render.com автоматически обнаружит изменения и развернет новую версию

## Требования к requirements.txt

Убедитесь, что в вашем файле `requirements.txt` присутствуют следующие зависимости:

```
aiogram>=3.0.0
python-dotenv
sqlalchemy
alembic
asyncpg
pytz
aiohttp
```

## Проблемы и их решение

1. **Бот не отвечает**:
   - Проверьте логи на Render.com
   - Убедитесь, что вебхук установлен правильно 
   - Проверьте, что сервис запущен и не в спящем режиме

2. **Ошибки с базой данных**:
   - Проверьте строку подключения к БД
   - Убедитесь, что миграции выполнены корректно

3. **Webhook не работает**:
   - Проверьте URL вебхука в логах
   - Убедитесь, что домен правильный и SSL сертификат актуален (Render.com обеспечивает SSL автоматически)

## Заключение

После выполнения всех шагов ваш TalkeryBot должен быть успешно развернут на Render.com и готов к использованию. Для проверки работы бота просто откройте диалог с ним в Telegram и отправьте команду `/start`.
